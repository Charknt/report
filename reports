import csv
import os
import numpy as np
import weighted  # uses your weighted.py analytics module

FILENAME = "ano.csv"

def show_reports_menu():
    """Menu for viewing and exporting analytics reports."""
    while True:
        print("\n=== REPORTS MENU ===")
        print("1. Show Weighted Grades")
        print("2. Show Grade Distribution (Aâ€“F)")
        print("3. Show Percentiles (Top/Bottom 10%)")
        print("4. Show Outliers (Â±2 SD from mean)")
        print("5. Show Improvement (Final - Midterm)")
        print("6. Export All Reports to CSV")
        print("7. Back to Main Menu")

        choice = input("Enter choice (1â€“7): ").strip()

        if choice == "1":
            weighted.compute_grades(FILENAME)
        elif choice == "2":
            weighted.grade_distribution(FILENAME)
        elif choice == "3":
            weighted.percentiles(FILENAME)
        elif choice == "4":
            weighted.outliers(FILENAME)
        elif choice == "5":
            weighted.improvement(FILENAME)
        elif choice == "6":
            export_reports()
        elif choice == "7":
            break
        else:
            print("âŒ Invalid choice. Try again.")


# ------------------------------------------------------------
# Export Reports
# ------------------------------------------------------------
def export_reports():
    """Export all analytics to separate CSV report files."""
    if not os.path.exists(FILENAME):
        print("âš ï¸ Data file not found.")
        return

    base = "reports"
    os.makedirs(base, exist_ok=True)

    # --- Weighted Grades Report ---
    with open(FILENAME, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        rows = []
        for r in reader:
            grade = weighted.compute_weighted(r)
            if grade is not None:
                rows.append([r["student_id"], r["last_name"], r["first_name"], grade])

    with open(os.path.join(base, "weighted_grades.csv"), "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["student_id", "last_name", "first_name", "weighted_grade"])
        writer.writerows(rows)

    # --- Grade Distribution Report ---
    grades = np.array([r[3] for r in rows], dtype=float)
    dist = {
        "A": np.sum(grades >= 90),
        "B": np.sum((grades >= 80) & (grades < 90)),
        "C": np.sum((grades >= 70) & (grades < 80)),
        "D": np.sum((grades >= 60) & (grades < 70)),
        "F": np.sum(grades < 60),
    }
    with open(os.path.join(base, "grade_distribution.csv"), "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["Grade", "Count"])
        for k, v in dist.items():
            writer.writerow([k, v])

    # --- Percentile Report ---
    sorted_rows = sorted(rows, key=lambda x: x[3], reverse=True)
    n = len(sorted_rows)
    top = sorted_rows[: max(1, n // 10)]
    bottom = sorted_rows[-max(1, n // 10) :]
    with open(os.path.join(base, "percentiles.csv"), "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["Type", "student_id", "last_name", "first_name", "grade"])
        for r in top:
            writer.writerow(["Top 10%", *r])
        for r in bottom:
            writer.writerow(["Bottom 10%", *r])

    print(f"\nğŸ’¾ All reports exported to the '{base}/' folder.")
